---
name: thesis-format-check
description: 卒業論文の体裁・形式を自動チェック。LaTeX(.tex)およびWord(.docx)に対応。未記入セクション、表記ゆれ、参考文献体裁、相互参照整合性などを検出。締め切り前の最終確認に使用。
argument-hint: "<.tex or .docx file path or directory> [--terms <用語ファイル>]"
---

# Thesis Format Check - 卒論体裁チェック

## Overview

卒業論文の体裁・形式面を網羅的にチェックし、提出前に修正すべき箇所を一覧で報告する。LaTeX(.tex)とWord(.docx)の両形式に対応。

## When to Use

- 卒論の提出前に体裁の最終チェックをしたいとき
- LaTeX論文またはWord論文のフォーマット不備を網羅的に洗い出したいとき
- `.docx` 形式の論文に対して、誤字脱字・節番号・参考文献番号・表記ゆれ等を一括チェックしたいとき
- 既存の `/review-paper` は内容面のレビューが主目的なので、**体裁面に特化したチェック**が必要なときはこちらを使う

```
使い分けガイド:
  卒論の体裁だけチェック       → /thesis-format-check（これ）
  卒論を包括レビュー           → /thesis-review
  研究論文を深くレビュー       → /review-paper
  説明不足を検出               → /check-articulation
```

## Input

$ARGUMENTS

- ファイルパス: `.tex` ファイル、`.docx` ファイル、またはディレクトリ（ディレクトリの場合は中の `.tex` / `.docx` を全て対象）
- `--terms <ファイル>`: 表記ゆれチェック用の用語リスト（任意）

## Instructions

### ペルソナ

ソフトウェア工学の一流研究者であり指導教員として、学生に対して親しみやすく具体的な指導口調でコメントする（「ここは直しましょう」「〜した方がいいです」等）。

### ファイル形式判定（最初に実行）

入力ファイルの拡張子で処理を分岐する:

- `.tex` → **LaTeX モード**（後述の「チェック項目（LaTeX）」を実行）
- `.docx` → **Word モード**（後述の「docx テキスト抽出」→「チェック項目（docx）」を実行）
- ディレクトリ → 中の `.tex` および `.docx` を全て対象とする

### docx テキスト抽出（Word モードのみ）

`.docx` ファイルはバイナリ形式のため、テキストを抽出してからチェックする。以下の順で試行:

1. **Read ツール**: まず Read ツールで直接読み取りを試みる
2. **python-docx**（推奨）: Read が失敗した場合、以下のスクリプトで全段落・スタイル情報を抽出する:

```python
python3 << 'PYEOF'
import docx

doc = docx.Document("<ファイルパス>")
for i, para in enumerate(doc.paragraphs):
    style = para.style.name if para.style else "None"
    text = para.text.strip()
    if text:
        print(f"[P{i:04d}|{style}] {text}")

for ti, table in enumerate(doc.tables):
    print(f"\n--- 表{ti+1} ---")
    for ri, row in enumerate(table.rows):
        cells = [cell.text.strip() for cell in row.cells]
        print(f"  行{ri}: {' | '.join(cells)}")
PYEOF
```

3. **pandoc**（フォールバック）: python-docx が使えない場合:

```bash
pandoc -f docx -t plain "<ファイルパス>" > extracted.txt
```

**注意**: python-docx はスタイル情報（見出しレベル等）も取得できるため推奨。pandoc はプレーンテキストのみとなり見出し構造の判定精度が下がる。

### チェック項目（共通 — LaTeX/docx 両方に適用）

以下の項目はファイル形式を問わず共通でチェックする。

#### C1. 句読点・記号の統一
- 句読点（、。）とカンマピリオド（，．）の混在チェック
- 日本語文中でカンマピリオドを使用する場合は**全角**（，．）であること（半角のコンマピリオドはレイアウトが崩れる）
- 文書全体で統一されているか

#### C2. タイトルの体裁
- タイトルに「提案」「研究」等の冗長語が含まれていないか（研究論文なので提案・研究するのは自明）
- 英語タイトルの**キャピタライゼーション**: 各単語の先頭を大文字にする。ただし補助語（to, of, in, for, and, the, a, an, on, at, by, with 等）は小文字のまま。タイトル先頭の語は常に大文字

#### C3. 図表タイトルの番号書式
- 図表タイトルの番号とタイトルの間にスペースが1つ入っているか（例: 「図1 ○○」「表2 ○○」）
- スペースなし（「図1○○」）やスペース過多になっていないか

#### C4. 章・節への言及形式
- 章や節に言及する場合に「第2章」「第2.2節」のように記述されているか
- 「2章」「2.2節」のように「第」が欠落していないか

#### C5. 箇条書きの多用検出
- 箇条書きが過度に使われていないか
- 特にページ数が少ない文書では箇条書きによる空白が目立つため、文章での記述を推奨

#### C6. 参考文献の引用形式
- **文中引用**: 通常表記で記載（例: 「文献[1]では…」「Spivakら[2]は…」）
- **句読点後の引用**: 上付き文字で記載（例: 「…を提案している^[1]」）
- 参考文献リストは `[番号] 著者, タイトル, 出典(学会名や論文誌名), ページ番号, 年.` の順序で統一されているか

#### C7. 謝辞の用語チェック
- 「指導教**官**」→「指導教**員**」に統一されているか（「官」は公務員に使用する用語であり、大学教員には「員」が適切）

#### C8. 英語論文チェック（英語で記述された論文の場合のみ適用）
- 主語 "I" の多用を避けているか（"The author" や無生物主語 "Chapter 3 describes…" 等が推奨）
- 強調は `"quote"` ではなく *italic*（イタリック体）で表記されているか

### チェック項目（LaTeX）

以下の項目を順にチェックし、該当箇所があれば報告する。

#### 1. 未記入・プレースホルダの検出
- セクションの中身が空、またはコメントだけのセクション
- 「ここに記載」「TODO」「TBD」「XXX」等のプレースホルダ
- `\begin{comment}...\end{comment}` ブロック（本文に影響する可能性）
- **注意**: LaTeXの `%` コメントはPDFに表示されないため言及不要

#### 2. 表記ゆれの検出
- 同一概念に対する異なる表記（例: 「バリアント」と「バリエーション」）
- 固有名詞のtypo（例: CodeRythm → CodeRhythm）
- 全角/半角の不統一
- `--terms` で用語リストが指定されている場合はそれも照合

#### 3. 参考文献の体裁
- ページ番号のハイフン: LaTeX慣例ではenダッシュ `--` を使う（`pp. 1965--1970`）
- 著者名、タイトル、会議名の表記統一
- URL参照の `accessed` 日付の統一

#### 4. label/ref の整合性
- `\ref{...}` で参照されているが `\label{...}` が定義されていないもの
- `\label{...}` が定義されているが一度も参照されていないもの
- PDF上で `??` と表示される未解決参照

#### 5. 図表の整合性
- `\caption` の有無
- 本文中で `\ref` による言及があるか
- 図表番号の順序（図1の前に図2を参照していないか）

#### 6. 定型セクションの確認
- 謝辞が記入されているか
- 目次が生成されているか
- タイトルページの要素（氏名、学籍番号、指導教員名、年度）

#### 7. 章の改ページ
- `\chapter` を使用している場合は自動改ページされるが、`\section` ベースの構成で章を構成している場合に `\clearpage` や `\newpage` が適切に挿入されているか

#### 8. その他の形式
- `\rule` 等による仮置き要素の残存
- subfiles構成の場合、全チャプターが `\subfile` されているか

### チェック項目（docx）

以下の項目を順にチェックし、該当箇所があれば報告する。抽出したテキストとスタイル情報を基に判定する。

#### 1. 未記入・プレースホルダの検出
- セクション見出しはあるが本文が空のセクション
- 「ここに記載」「TODO」「TBD」「XXX」「〜を記述します」等のプレースホルダ・メタ的記述の残存
- 仮テキストや下書きメモが本文に混入していないか

#### 2. 誤字脱字の検出
- 明らかな誤変換（例: 「以上」→「異常」、「構想」→「構造」）
- タイポ（例: 「プログミング」→「プログラミング」）
- 英単語のスペルミス（例: 「Onthology」→「Ontology」）
- 文字の欠落・文字化け

#### 3. 表記ゆれの検出
- 同一概念に対する異なる表記
- 固有名詞の表記統一
- **全角/半角の混在チェック**:
  - 括弧: `(` vs `（`、`)` vs `）`
  - 数字: `1` vs `１`、`2` vs `２`
  - スペース: 半角スペース vs 全角スペース
- **文体の統一チェック**: 「である」調と「ですます」調の混在
- `--terms` で用語リストが指定されている場合はそれも照合

#### 4. 参考文献の体裁
- 参考文献リスト内のフォーマット統一（著者名、タイトル、出版社、年の形式）
- 番号と本文の間のスペース統一（例: `[1] 著者` vs `[1]著者`）
- 末尾のピリオド統一
- **本文中の引用番号と参考文献リストの整合性**: 本文で `[N]` と引用した内容が、参考文献リストの `[N]` と一致しているか

#### 5. 相互参照・図表の整合性（label/ref に相当）
- 本文中で「図N」「表N」と言及した番号が、実際の図表番号と一致しているか
- 図表キャプションの有無
- 図表番号の登場順（図1の前に図2を参照していないか）
- 図表番号の全角/半角統一（「図1」vs「図１」）

#### 6. 節番号の連番・欠落チェック（docx特有）
- 全ての章・節見出しに適切な節番号が付与されているか
- 見出しレベル（H1/H2/H3/H4）と番号体系の整合性（例: H2なのに「3.4.1」のような3階層番号になっていないか）
- 見出しレベルのスキップ（H2の直下にH4等）がないか
- 章番号と無関係な独自番号（「1.」「2.」「①」「②」等）が見出しに使われていないか
- 番号と見出しテキストの間のスペース統一

#### 7. 定型セクションの確認
- 要旨（Abstract）の有無
- 謝辞が記入されているか
- 目次の有無
- タイトルページの要素（氏名、学籍番号、指導教員名、年度）
- 「本稿の構成」に記載された章数と実際の章数の一致

#### 8. レイアウトチェック（docx特有）
- **両端揃え（Justified Alignment）**: 本文や参考文献リストが「左揃え」ではなく「両端揃え」になっているか（python-docx で `paragraph.alignment` を確認）
- **段落先頭の字下げ**: 各段落の先頭が1文字分字下げ（インデント）されているか。最初の行以外は字下げしない
- **段落間の間隔統一**: 段落ごとに行間スペースが異なっていないか。全体で統一されているか
- **章の改ページ**: 各章（H1レベルの見出し）が新しいページから始まっているか

#### 9. その他の形式
- 数式オブジェクトの消失（括弧内が空、主語が欠落している箇所は数式消失の可能性）
- Wordのコメントや変更履歴の残存
- ページ番号の有無・整合性

### 出力ルール

- 内部用語（殿、足軽等）を出力に含めない
- 発見した問題を優先度順（致命的 > 高 > 中 > 低）に整理
- 各指摘に対し、具体的な修正方法を示す

## Output Format

```markdown
# 体裁チェック結果: [論文タイトル]

**チェック日**: [日付]
**対象ファイル**: [ファイルパス]
**ファイル形式**: LaTeX (.tex) / Word (.docx)

## 致命的（提出前に必ず修正）
1. **[問題]** ([ファイル:行番号 or 段落番号])
   - 現状: [具体的な記述]
   - 修正: [具体的な修正方法]

## 高優先度（強く修正を推奨）
1. ...

## 中優先度（できれば修正）
1. ...

## 低優先度（余裕があれば）
1. ...

## チェックサマリ
```

**LaTeX の場合:**

```markdown
| チェック項目 | 結果 | 指摘数 |
|-------------|------|--------|
| 句読点・記号の統一 | ✅ / ⚠️ | N件 |
| タイトルの体裁 | ✅ / ⚠️ | N件 |
| 未記入・プレースホルダ | ✅ / ⚠️ | N件 |
| 表記ゆれ | ✅ / ⚠️ | N件 |
| 参考文献体裁・引用形式 | ✅ / ⚠️ | N件 |
| label/ref整合性 | ✅ / ⚠️ | N件 |
| 図表整合性・番号書式 | ✅ / ⚠️ | N件 |
| 章・節の言及形式 | ✅ / ⚠️ | N件 |
| 定型セクション・謝辞用語 | ✅ / ⚠️ | N件 |
| 章の改ページ | ✅ / ⚠️ | N件 |
| 箇条書きの多用 | ✅ / ⚠️ | N件 |
| 英語論文チェック（該当時） | ✅ / ⚠️ / ― | N件 |
```

**docx の場合:**

```markdown
| チェック項目 | 結果 | 指摘数 |
|-------------|------|--------|
| 句読点・記号の統一 | ✅ / ⚠️ | N件 |
| タイトルの体裁 | ✅ / ⚠️ | N件 |
| 未記入・プレースホルダ | ✅ / ⚠️ | N件 |
| 誤字脱字 | ✅ / ⚠️ | N件 |
| 表記ゆれ（全角半角・文体含む） | ✅ / ⚠️ | N件 |
| 参考文献体裁・引用形式 | ✅ / ⚠️ | N件 |
| 相互参照・図表整合性・番号書式 | ✅ / ⚠️ | N件 |
| 章・節の言及形式 | ✅ / ⚠️ | N件 |
| 節番号の連番・欠落 | ✅ / ⚠️ | N件 |
| 定型セクション・謝辞用語 | ✅ / ⚠️ | N件 |
| レイアウト（両端揃え・字下げ等） | ✅ / ⚠️ | N件 |
| 章の改ページ | ✅ / ⚠️ | N件 |
| 箇条書きの多用 | ✅ / ⚠️ | N件 |
| その他の形式（数式消失等） | ✅ / ⚠️ | N件 |
| 英語論文チェック（該当時） | ✅ / ⚠️ / ― | N件 |
```

## Guidelines

- 体裁面に徹する。内容の論理的な指摘は `/thesis-review` や `/review-paper` の役割
- **LaTeX モード**: `%` コメントはPDFに出ないため言及しない
- **Word モード**: python-docx で取得したスタイル情報（Heading 1/2/3 等）を活用し、見出し構造を正確に把握する
- 問題がない項目も「✅ 問題なし」と明記し、チェック漏れがないことを示す
- 複数ファイル構成（LaTeX subfiles / ディレクトリ内の複数 docx）の場合、全ファイルを横断してチェックする
- `.tex` 入力時の動作は一切変更しない（後方互換性を維持）
